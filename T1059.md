# ‚ö° T1059 ‚Äî PowerShell Abuse Detection (Living off the Land)

---

## üìñ Overview

This detection documents **PowerShell abuse** identified through a combination of:

- **Wazuh preset detection rules**
- **Custom keyword-based PowerShell Script Block analysis**
- **Sysmon telemetry**

The objective is to demonstrate how **multiple alert sources and severities** contribute to effective SOC triage and investigation when PowerShell is abused during the delivery phase of an attack.

This detection was validated using **Atomic Red Team (T1059.001)** in a controlled lab environment.

---

## ‚öîÔ∏è Attack Simulation

**Simulation Tool:** Atomic Red Team  

**MITRE ATT&CK Technique:**  
- **T1059.001 ‚Äî PowerShell**

**Atomic Test Executed:**

- `Invoke-AtomicTest T1059.001 -TestNumbers 1`

### Simulation Summary

Atomic Red Team was used to emulate an adversary downloading and executing **Mimikatz** via a PowerShell script.

The activity resulted in:

- Obfuscated PowerShell script execution  
- Downstream malicious file creation detected by Sysmon  
- Multiple alerts of varying severity generated by Wazuh (Process, File, and Script Content)  

---

## ‚öôÔ∏è Pre-Detection Configuration

### 1Ô∏è‚É£ PowerShell Logging Enablement

PowerShell does not log full script content by default.

Registry changes were applied to enable:

- **Registry Key: HKLM\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging**
- **Value: EnableScriptBlockLogging = 1**
- **PowerShell Script Block Logging (Event ID 4104)**

This allowed inspection of executed PowerShell script content *after* de-obfuscation.

---

### 2Ô∏è‚É£ Wazuh Log Collection Configuration

The Wazuh agent was configured to ingest:

- **Microsoft-Windows-PowerShell/Operational** logs

This was achieved by updating `ossec.conf` to explicitly include the specific Event Channel as a monitored source.

---

### 3Ô∏è‚É£ Sysmon (Pre-Existing)

Sysmon was already configured (SwiftOnSecurity configuration) and provided:

- File creation telemetry (**Event ID 11**)  
- Process creation context (**Event ID 1**)  

---

## üìä Telemetry Sources

- **PowerShell Operational Logs**  
  - Event ID: **4104 ‚Äî Script Block Logging**

- **Sysmon**  
  - Event ID: **11 ‚Äî File Creation**

- **Windows Security**  
  - Event ID: **4688 ‚Äî Process Creation**

---

## üö® Detection Results

During simulation, **three key alerts were generated**, creating a layered *Defense in Depth* detection pipeline.

---

### üî¥ Critical Severity Alert ‚Äî Payload Drop Detected (Preset Rule)

**Source:** Sysmon  

**Rule Type:** Wazuh preset  

**Description:**  
> Executable file dropped in folder commonly used by malware

This alert represents **high-confidence malicious behavior** resulting from the script execution, indicating that the PowerShell command successfully staged a payload on disk.

---

### üü° Medium Severity Alert ‚Äî PowerShell Remote Execution (Preset Rule)

**Source:** PowerShell  

**Rule Type:** Wazuh preset  

**Description:**  
> PowerShell script used `Invoke-Command` cmdlet to execute code on a remote computer

This alert highlights suspicious PowerShell usage associated with **command execution** and serves as a behavioral indicator of the attack delivery method.

---

### üü° Medium Severity Alert ‚Äî Keyword-Based Script Block Detection (Custom Rule)

**Source:** PowerShell Script Block Logging  

**Rule Type:** Custom (Analyst-authored)  

**Description:**  
> CRITICAL: Mimikatz keyword detected in PowerShell Script Block

This alert was designed to **add analyst clarity** by explicitly identifying the presence of high-risk tooling keywords within the de-obfuscated script content, confirming malicious intent.

---

## üõ†Ô∏è Custom Wazuh Detection Rule

The following custom rule was added to `local_rules.xml` to enhance analyst visibility:

```xml
<rule id="100002" level="12">
  <if_group>windows</if_group>
  <field name="win.system.eventID">^4104$</field>
  <field name="win.eventdata.scriptBlockText" type="pcre2">(?i)mimikatz</field>
  <description>CRITICAL: Mimikatz keyword detected in PowerShell Script Block</description>
  <mitre>
    <id>T1003</id>
    <id>T1059.001</id>
  </mitre>
</rule>
```

### Rule Purpose

- Targets **PowerShell Script Block events (4104) only**
- Uses PCRE2 regex (`(?i)`) for case-insensitive keyword matching
- Complements preset rules by providing **human-readable context**
- Reduces SOC investigation time by confirming *which* tool was executed

---

## üì∏ Evidence

Screenshots captured during detection validation:

```text
screenshots/T1059_sysmon_file_drop.jpg
screenshots/T1059_powershell_invoke_command.jpg
screenshots/T1059_scriptblock_mimikatz_custom.jpg
```

---

## üó∫Ô∏è MITRE ATT&CK Mapping

| Tactic | Technique | ID |
|-------|----------|----|
| Execution | PowerShell | T1059.001 |
| Credential Access | OS Credential Dumping | T1003 |
| Lateral Movement | Remote Services | T1021.006 |

---

## üìù Notes

This detection demonstrates how **preset SIEM detections and custom analyst rules** work together in a SOC environment.

Preset rules provide broad behavioral coverage (file drop and execution), while the custom rule adds **specific attribution** (Mimikatz) without replacing vendor logic.
